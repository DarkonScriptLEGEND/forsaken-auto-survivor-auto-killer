--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")
local SoundService = game:GetService("SoundService")
local LocalPlayer = Players.LocalPlayer

--// Variables
local active, viewing, cooldown = false, nil, false
local circleLoopEnabled, selfDestructEnabled = false, false
local lastSafePosition = nil
local behindCooldown = false
local lastCheck = tick()

--// Sound Setup
local function playSound(id, volume)
	local sound = Instance.new("Sound", SoundService)
	sound.SoundId = "rbxassetid://" .. id
	sound.Volume = volume or 1
	sound:Play()
	Debris:AddItem(sound, 5)
end

--// Floating Text
local function floatText(text, color, duration)
	local billboard = Instance.new("BillboardGui", LocalPlayer.Character)
	billboard.Size = UDim2.new(0, 200, 0, 50)
	billboard.StudsOffset = Vector3.new(0, 4, 0)
	billboard.AlwaysOnTop = true
	billboard.Adornee = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

	local label = Instance.new("TextLabel", billboard)
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = color
	label.TextScaled = true

	Debris:AddItem(billboard, duration)
end

--// Particles
local function spawnParticles(part)
	local emitter = Instance.new("ParticleEmitter", part)
	emitter.Speed = NumberRange.new(0, 0)
	emitter.Rate = 50
	emitter.Lifetime = NumberRange.new(0.5)
	emitter.Size = NumberSequence.new(1)
	emitter.Color = ColorSequence.new(Color3.new(1, 1, 0))
	Debris:AddItem(emitter, 1)
end

--// Get Nearest Player
local function getNearest(radius)
	local nearest, dist = nil, radius
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local mag = (plr.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
			if mag < dist then
				nearest, dist = plr, mag
			end
		end
	end
	return nearest
end

--// Teleport Logic
local function teleportTo(pos)
	local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not root then return end
	playSound("9118823102", 2)
	spawnParticles(root)
	root.CFrame = CFrame.new(pos)
end

--// Rescue Teleport
local function teleportToSafe()
	if not lastSafePosition then return end
	local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not root then return end
	behindCooldown = true
	teleportTo(lastSafePosition)
	floatText("Successfully bypassed anti cheat", Color3.fromRGB(0, 255, 0), 3)
	task.delay(2.3, function()
		behindCooldown = false
	end)
end

--// Circle Loop
local function startCircleLoop()
	if cooldown then return end
	cooldown = true
	local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	local angle = 0
	for _ = 1, 5 do
		angle += math.pi / 6
		local offset = Vector3.new(math.cos(angle), 0, math.sin(angle)) * 60
		teleportTo(root.Position + offset)
		task.wait(0.3)
	end
	floatText("Circle Loop!", Color3.fromRGB(255, 255, 0), 2)
	task.wait(5)
	cooldown = false
end

--// Self Destruct
local function startSelfDestruct()
	if cooldown then return end
	cooldown = true
	floatText("Self Destruct!", Color3.fromRGB(255, 0, 0), 2)
	for _ = 1, 12 do
		teleportTo(LocalPlayer.Character.HumanoidRootPart.Position + Vector3.new(0, 30, 0))
		playSound("7489482123", 1)
		task.wait(0.2)
	end
	cooldown = false
end

--// GUI Setup
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "BehindYaMini"
gui.ResetOnSpawn = false

local toggleBtn = Instance.new("TextButton", gui)
toggleBtn.Size = UDim2.new(0, 180, 0, 30)
toggleBtn.Position = UDim2.new(0, 10, 0, 10)
toggleBtn.Text = "Behind Ya: OFF"
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
toggleBtn.MouseButton1Click:Connect(function()
	active = not active
	toggleBtn.Text = active and "Behind Ya: ON" or "Behind Ya: OFF"
	toggleBtn.BackgroundColor3 = active and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(0, 0, 255)
end)

local selfBtn = Instance.new("TextButton", gui)
selfBtn.Size = UDim2.new(0, 180, 0, 30)
selfBtn.Position = UDim2.new(0, 10, 0, 45)
selfBtn.Text = "Enable Self Destruct"
selfBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
selfBtn.MouseButton1Click:Connect(function()
	selfDestructEnabled = not selfDestructEnabled
	selfBtn.Text = selfDestructEnabled and "Self Destruct: ON" or "Enable Self Destruct"
end)

local loopBtn = Instance.new("TextButton", gui)
loopBtn.Size = UDim2.new(0, 180, 0, 30)
loopBtn.Position = UDim2.new(0, 10, 0, 80)
loopBtn.Text = "Enable Circle Loop"
loopBtn.BackgroundColor3 = Color3.fromRGB(255, 180, 80)
loopBtn.MouseButton1Click:Connect(function()
	circleLoopEnabled = not circleLoopEnabled
	loopBtn.Text = circleLoopEnabled and "Circle Loop: ON" or "Enable Circle Loop"
end)

--// Main Loop
RunService.Heartbeat:Connect(function()
	local char = LocalPlayer.Character
	if not char or not char:FindFirstChild("HumanoidRootPart") then return end
	local root = char.HumanoidRootPart
	local now = tick()

	-- Save safe position
	if root.Position.Y > -10 and root.Position.Y < 10000 then
		lastSafePosition = root.Position
	end

	-- Rescue if stuck
	local velocity = root.Velocity
	if (Workspace:FindPartOnRayWithIgnoreList(Ray.new(root.Position, Vector3.new(0, -4, 0)), {char}) == nil) or
		root.Position.Y < -10 or
		math.abs(velocity.Y) > 100 then

		if now - lastCheck >= 0.35 and not behindCooldown then
			teleportToSafe()
			lastCheck = now
		end
	end

	-- Core behavior
	if not active or behindCooldown or cooldown then return end

	local target = getNearest(85)
	if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
		local root2 = target.Character.HumanoidRootPart
		local behindPos = root2.Position - root2.CFrame.LookVector * 45
		teleportTo(behindPos)
		floatText("Poof", Color3.fromRGB(255, 255, 255), 1)
		task.wait(2.3)
	end

	local closeEnemy = getNearest(35)
	if selfDestructEnabled and closeEnemy then
		task.wait(0.75)
		startSelfDestruct()
	end

	local farEnemy = getNearest(195)
	if circleLoopEnabled and farEnemy then
		startCircleLoop()
	end
end)
